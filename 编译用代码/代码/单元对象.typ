/*
: æœ¬æ–‡ä»¶å‘å¤–æš´éœ²çš„å‡½æ•°æœ‰ï¼š
:     1. Hæ–°å•å…ƒå¯¹è±¡H: åˆ›å»ºæ–° å•å…ƒå¯¹è±¡ã€‚
:     2. Hè½¬ä¸ºå•å…ƒå¯¹è±¡H: è§£æå­—ç¬¦ä¸²ï¼Œè¿”å› å•å…ƒå¯¹è±¡ã€‚
*/

#import "å­—ç¬¦.typ": Hå»æ–‡æœ¬ä¸¤ç«¯H

// è¿”å› å•å…ƒå¯¹è±¡ï¼ˆå­—å…¸ç±»å‹ï¼‰ã€‚
#let Hæ–°å•å…ƒå¯¹è±¡H(
  æ­£æ–‡å­—:"", 
  é€šè¡Œå­—:"", 
  å°¾æ³¨:"", 
  è¡Œå·:"", 
  ç”¨äºæ¯”è¾ƒå­—:"",
  æ ·å¼æ ‡è®°:(), 
  å¥åºé¢œè‰²:"",
  æ‰“å°å¯¹è±¡:"") = {(

  // [][][][]åŸå§‹å››æ•°æ®ã€‚
  æ­£æ–‡å­—:æ­£æ–‡å­—,
  é€šè¡Œå­—:é€šè¡Œå­—, 
  å°¾æ³¨:å°¾æ³¨, 
  è¡Œå·:è¡Œå·, 
  
  // (
  //    "æ®‹å­—", "è¡¥æ–‡", "è„±æ–‡", "è¡æ–‡", "å ä½",
  //    "æ³¨é‡Šåˆ—", "å…±ç”¨é€šè¡Œå­—", "åˆ—å«å…±ç”¨é€šè¡Œå­—", "ç‰ˆæœ¬æ ‡é¢˜"
  // )
  æ ·å¼æ ‡è®°:æ ·å¼æ ‡è®°,
  ç”¨äºæ¯”è¾ƒå­—:ç”¨äºæ¯”è¾ƒå­—, 
  å¥åºé¢œè‰²: å¥åºé¢œè‰²,
  æ‰“å°å¯¹è±¡: æ‰“å°å¯¹è±¡
)}

// è§£æ"ä¾‹" æˆ– "[ä¾‹][][][]"ï¼Œè¿”å› å•å…ƒå¯¹è±¡ï¼ˆå­—å…¸ç±»å‹ï¼‰ã€‚
#let Hè½¬ä¸ºå•å…ƒå¯¹è±¡H(Iå•å…ƒå­—ç¬¦ä¸²I) = {

  // ä¸å« â€œ[â€ æˆ– â€œ]â€ã€‚
  if not Iå•å…ƒå­—ç¬¦ä¸²I.contains(regex("\[|\]")) {
    return Hæ–°å•å…ƒå¯¹è±¡H(æ­£æ–‡å­—: Iå•å…ƒå­—ç¬¦ä¸²I, ç”¨äºæ¯”è¾ƒå­—: Iå•å…ƒå­—ç¬¦ä¸²I)
  }

  // æ˜¯å¦ç¬¦åˆ[][][][]æ ¼å¼è¦æ±‚ã€‚
  if not ( Iå•å…ƒå­—ç¬¦ä¸²I.contains(regex("^\[.*\]$")) and /*
       */  Iå•å…ƒå­—ç¬¦ä¸²I.replace(regex("[^\[\]]"), "") == "[][][][]"){
    panic("[][][][]æ ¼å¼ä¸åŒ¹é…ï¼š" + Iå•å…ƒå­—ç¬¦ä¸²I)
  }

  // è§£æ[][][][]å„éƒ¨åˆ†ã€‚
  let result = Hæ–°å•å…ƒå¯¹è±¡H()
  ( 
    result.æ­£æ–‡å­—, 
    result.é€šè¡Œå­—, 
    result.å°¾æ³¨, 
    result.è¡Œå·
  ) = Hå»æ–‡æœ¬ä¸¤ç«¯H(Iå•å…ƒå­—ç¬¦ä¸²I, "[_]").split("][")

  // æ­£æ–‡å­—æ˜¯æ®‹å­—ã€‚
  if result.æ­£æ–‡å­—.contains(regex("^ã€šF[^ã€›]+ã€›$")) {
    result.æ­£æ–‡å­— = Hå»æ–‡æœ¬ä¸¤ç«¯H(result.æ­£æ–‡å­—, "ã€šF_ã€›")
    result.æ ·å¼æ ‡è®°.push("æ®‹å­—")
  }

  // åŒ…å«è¡Œå·ã€‚
  if result.è¡Œå· != "" {
    result.è¡Œå· = Hå»æ–‡æœ¬ä¸¤ç«¯H(result.è¡Œå·, "ã€šL_ã€›")
  }

  // è¡¥æ–‡ï¼Œå†™åˆ°æ­£æ–‡å­—ã€æ ‡è®°è¡¥æ–‡ã€‚
  if result.é€šè¡Œå­—.starts-with("è¡¥æ–‡ï¼š") {
    if result.æ­£æ–‡å­— != "" or result.é€šè¡Œå­— == "è¡¥æ–‡ï¼š".trim() {
      panic("è¡¥æ–‡ä¸æ­£æ–‡å­—ä¸å…±å­˜ï¼Œæˆ–è¡¥æ–‡ä¸èƒ½ä¸ºç©ºï¼š", Iå•å…ƒå­—ç¬¦ä¸²I)
    }
    result.æ­£æ–‡å­— = Hå»æ–‡æœ¬ä¸¤ç«¯H(result.é€šè¡Œå­—, "è¡¥æ–‡ï¼š_")
    result.æ ·å¼æ ‡è®°.push("è¡¥æ–‡")
    result.é€šè¡Œå­— = ""
  }
  
  // æ ‡è®°è„±æ–‡ã€‚
  if result.é€šè¡Œå­— == "è„±æ–‡" {
    if result.æ­£æ–‡å­— != "" and result.é€šè¡Œå­— == "è„±æ–‡" {
      panic("è„±æ–‡ï¼š", Iå•å…ƒå­—ç¬¦ä¸²I)
    }
    result.æ ·å¼æ ‡è®°.push("è„±æ–‡") 
    result.é€šè¡Œå­— = ""
  }
  
  // æ ‡è®°è¡æ–‡ã€‚
  if result.é€šè¡Œå­— == "è¡æ–‡" {
    result.æ ·å¼æ ‡è®°.push("è¡æ–‡")
    result.é€šè¡Œå­— = ""
  }
  
  // æ ‡è®°å ä½ã€‚
  if result.é€šè¡Œå­— == "å ä½" {
    result.æ ·å¼æ ‡è®°.push("å ä½")
    result.é€šè¡Œå­— = ""
  }
  
  // å°¾æ³¨æ ‡è®°
  if result.å°¾æ³¨ != "" {

    // è½¬æ¢å¤§å†™ è‡³ å°å†™+ç®­å¤´ã€‚
    let temp = result.å°¾æ³¨
                .replace("T", "tâ†–â†—").replace("R","râ†—â†˜")
                .replace("B", "bâ†™â†˜").replace("L", "lâ†–â†™")
                .replace("ğŸ“", "")

    if not result.å°¾æ³¨.starts-with("ğŸ“") or/* è¦ä»¥ğŸ“èµ·å§‹
    */ temp.codepoints().len() != temp.codepoints().dedup().len() or /* ä¸èƒ½æœ‰é‡å¤
    */ temp.codepoints().filter(x => x not in ("trblâ†–â†—â†˜â†™")).len() != 0 { // ä¸å…è®¸æœ‰å…¶ä»–å­—ç¬¦ã€‚
      panic("å°¾æ³¨ï¼š", Iå•å…ƒå­—ç¬¦ä¸²I)
    }
    result.å°¾æ³¨ = temp
  }
  
  // ç»™å‡ºç”¨äºæ¯”è¾ƒå­—ã€‚
  result.ç”¨äºæ¯”è¾ƒå­— = if result.é€šè¡Œå­— != "" {result.é€šè¡Œå­—}
                     else {result.æ­£æ–‡å­—}

  // é€šè¡Œå­—å¿…é¡»è¦ä»¥â€œï¼ˆâ€ã€â€œã€ˆâ€å¼€å§‹ã€‚
  if result.é€šè¡Œå­— != "" and not result.é€šè¡Œå­—.starts-with(regex("ï¼ˆ|ã€ˆ")) {
    panic("é€šè¡Œå­—å¿…é¡»ä»¥ï¼ˆã€ˆå¼€å§‹", Iå•å…ƒå­—ç¬¦ä¸²I)
  }
  return result
}