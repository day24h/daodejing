/*
: 本文件向外暴露的函数有：
:     1. IDS: 字符串中所有IDS，替换成相应字符。
:     2. H去文本两端H: 去字符串两端的指定字符。
:     3. H全部章节名H: 常量数组，(“第一章”, ..., “第八十一章”)
:     4. H汉转阿拉伯H: 四十四 → 44
*/

// 配置 IDS（Ideographic Description Sequence）至 codepoint 数组
// 然后codepoint 都转为字符。
// - 为什么 "〚⿰彳袁〛"会对应 "E103"？
//   因为在自制字体的E103码位，绘制了与`⿰彳袁`的对应图形。
#let I数组-表意文字描述序列至码位I = (
  // 王弼本 :::::::::: 
  ("〚弼本底本字形斲〛", "E003"), 

  // 帛书本 ::::::::::
  ("〚⿱⿰⿴𠂊⺀犬示〛", "E101"),  
  ("〚⿰彳⿱艹呆〛", "E102"),
  ("〚⿰彳袁〛", "E103"),
  ("〚⿲彳⿱山耳攵〛", "E104"),
  ("〚⿱徵耳〛", "E105"),
  ("〚⿰彳㿝〛", "E106"),
  ("〚⿱⿰舟㕛寸〛", "E107"),
  ("〚⿰⿱⿻十口糸隹〛", "E108"),
  ("〚⿱釆𠦒〛", "E109"),
  ("〚⿰骨恆〛", "E10A"),
  ("〚⿱璧月〛", "E10B"),
  ("〚⿰末刂〛", "E10C"),
  ("〚⿱𥫗壐〛", "E10D"),
  ("〚⿱𥫗片〛", "E10E"),
  ("〚⿳⺌⿸𡕒攵心〛", "E10F"),
  ("〚⿱𡕖廾〛", "E110"),
  ("〚⿱士𣎾〛", "E111"),
  ("〚⿰禾⿱攴旨〛", "E112"),
  ("〚⿰𥝌⿱又甘〛", "E113"),
  ("〚⿱⿰彳咼貝〛", "E114"),
  ("〚⿱𢼧貝〛", "E115"),
  ("〚⿱厸文〛", "E116"),
  ("〚⿱宀⿰身邑〛", "E117"),
  ("〚⿵門肙〛", "E118"),
  ("〚⿱𡉅禾〛", "E119"),
  ("〚⿳宀茻圶〛", "E11A"),
  ("〚⿱𢼧壬〛", "E11B"),
  ("〚𪋻字之去三比〛", "E11C"),
  ("〚⿳⿰⿴𠂊⺀犬二火〛", "E11D"),
  ("〚⿰立朁〛", "E11E"),
  ("〚⿰皀㤅〛", "E11F"),
  ("〚⿱以心〛", "E120"),
  ("〚⿱⿰合心羽〛", "E121"),
  ("〚⿰忄蒪〛", "E122"),
  ("〚⿰粦几〛", "E123"),
  ("〚⿵門忈〛", "E124"),
  ("〚⿹戈貝〛", "E125"),
  ("〚⿱玉曲〛", "E126"),
  ("〚⿰杲系〛", "E127"),
  ("〚⿵門糸〛", "E128"),
  ("〚⿺風剽〛", "E129"),
  ("〚⿱用力〛", "E12A"),
  ("〚⿰爫乚〛", "E12B"),
  ("〚⿰□乚〛", "E12C"),
  ("〚⿰□元〛", "E12D"),
  ("〚⿰□兌〛", "E12E"),
  ("〚⿰□吾〛", "E12F"),
  ("〚⿰口□〛", "E130"),
  ("〚⿰月□〛", "E131"),
  ("〚⿰木□〛", "E132"),
  ("〚⿰王□〛", "E133"),
  ("〚帛甲未識字守靜篤之篤〛", "E134"),
  ("〚帛甲未識字恬淡爲上之淡〛", "E135"),
  ("〚帛甲未識字柔弱勝强之柔〛", "E136"),
  ("〚⿱微耳〛", "E137"),
  ("〚帛書異體字曓〛", "E138"),
  ("〚帛書底本字形曓〛", "E139"),
  ("〚帛書底本字形尚〛", "E13A"),
  ("〚帛書底本字形表〛", "E13B"),
  ("〚幾字之去右幺〛", "304A8"),
  ("〚⿱剌虫〛", "31FF4"),
  ("〚⿰爭青〛", "32296"),
  ("〚⿰米目〛", "31E37"),

  // 郭店本 :::::::::: 
  ("〚⿱畐示〛", "E201"),  
  ("〚⿱⿰⿴𠂊⺀攵示〛", "E202"),
  ("〚⿱同示〛", "E203"),
  ("〚⿰⿳屮二屮斤〛", "E204"),
  ("〚⿱⿰爿戓貝〛", "E205"),
  ("〚⿱尔賏〛", "E206"),
  ("〚⿱㚖心〛", "E207"),
  ("〚⿱⿲氵⿱立𠂤欠𠚕〛", "E208"),
  ("〚⿱未口〛", "E209"),
  ("〚⿱月口〛", "E20A"),
  ("〚⿱喪死〛", "E20B"),
  ("〚⿺辶己〛", "E20C"),
  ("〚⿱㞢止〛", "E20D"),
  ("〚⿱⿻丨⿳𣥖一𣥖又〛", "E20E"),
  ("〚⿱化止〛", "E20F"),
  ("〚⿱⿰彳𠤎心〛", "E210"),
  ("〚⿺辶⿳人一月〛", "E211"),
  ("〚⿱爲䖵〛", "E212"),
  ("〚⿺辶⿱人古〛", "E213"),
  ("〚⿺辶⿱𦥔少〛", "E214"),
  ("〚⿺辶𦣻〛", "E215"),
  ("〚⿺辶⿱日各〛", "E216"),
  ("〚⿱菐臣〛", "E217"),
  ("〚⿳菐臣又〛", "E218"),
  ("〚⿰𡉣⿱丮女〛", "E219"),
  ("〚⿰見⿱袁止〛", "E21A"),
  ("〚⿱⿰矢于日〛", "E21B"),
  ("〚⿱隹臼〛", "E21C"),
  ("〚⿱尹羊〛", "E21D"),
  ("〚⿰𡵂女〛", "E21E"),
  ("〚⿰女⿱山𠮛〛", "E21F"),
  ("〚⿱難土〛", "E220"),
  ("〚⿱𩀤土〛", "E221"),
  ("〚⿱⿰堇⿱隹土心〛", "E222"),
  ("〚⿱㠯心〛", "E223"),
  ("〚⿰鼎勿〛", "E224"),
  ("〚⿰夕刂〛", "E225"),
  ("〚⿸⿻𠃊丿口〛", "E226"),
  ("〚⿱𠂹右〛", "E227"),
  ("〚⿱𠍳貝〛", "E228"),
  ("〚⿱石句〛", "E229"),
  ("〚⿰木⿱菐臣〛", "E22A"),
  ("〚⿳业关⿱臣木〛", "E22B"),
  ("〚⿱矛求〛", "E22C"),
  ("〚⿱直木〛", "E22D"),
  ("〚⿴囗乇〛", "E22E"),
  ("〚⿷匚或〛", "E22F"),
  ("〚⿰⿷匚或阝〛", "E230"),
  ("〚⿴囗右〛", "E231"),
  ("〚⿱弼貝〛", "E232"),
  ("〚⿱宀貢〛", "E233"),
  ("〚⿰邑丰〛", "E234"),
  ("〚⿱日丌〛", "E235"),
  ("〚⿱亦夕〛", "E236"),
  ("〚⿱青米〛", "E237"),
  ("〚⿱爫家〛", "E238"),
  ("〚⿱富示〛", "E239"),
  ("〚⿰害又〛", "E23A"),
  ("〚⿱宀身〛", "E23B"),
  ("〚⿰爿方〛", "E23C"),
  ("〚⿰亻⿱乍又〛", "E23D"),
  ("〚⿱𠦪止〛", "E23E"),
  ("〚⿱石主〛", "E23F"),
  ("〚⿸尾出〛", "E240"),
  ("〚⿱目人〛", "E241"),
  ("〚⿰見雚〛", "E242"),
  ("〚⿰見兆〛", "E243"),
  ("〚⿸尸⿱勿水〛", "E244"),
  ("〚⿱矛人〛", "E245"),
  ("〚⿰言⿱厶⿹𠃌一〛", "E246"),
  ("〚⿱鬼心〛", "E247"),
  ("〚⿱⿰廌去水〛", "E248"),
  ("〚⿰⿱丙口犬〛", "E249"),
  ("〚⿰幸⿱丮女〛", "E24A"),
  ("〚⿰⿱十言斤〛", "E24B"),
  ("〚⿱艹㣽〛", "E24C"),
  ("〚⿱⿳人一月心〛", "E24D"),
  ("〚⿱穴沐〛", "E24E"),
  ("〚⿰紿司〛", "E24F"),
  ("〚⿰氵毋〛", "E250"),
  ("〚⿱青水〛", "E251"),
  ("〚⿱𠂂日〛", "E252"),
  ("〚⿱㞢室〛", "E253"),
  ("〚⿱㞢貝〛", "E254"),
  ("〚⿱㞢木〛", "E255"),
  ("〚⿱牙廾〛", "E256"),
  ("〚⿱𦥔木〛", "E257"),
  ("〚⿱女又〛", "E258"),
  ("〚⿱女子〛", "E259"),
  ("〚⿴女𠃎〛", "E25A"),
  ("〚⿱鼎心〛", "E25B"),
  ("〚⿰戈戈〛", "E25C"),
  ("〚⿰奇戈〛", "E25D"),
  ("〚⿱⿰弓𠮡力〛", "E25E"),
  ("〚⿺𠃊⿻𢆶一〛", "E25F"),
  ("〚⿺𠃊⿻幺一〛", "E260"),
  ("〚⿱賏縈〛", "E261"),
  ("〚⿱穆糸〛", "E262"),
  ("〚⿰糹龏〛", "E263"),
  ("〚⿱甶䖵〛", "E264"),
  ("〚⿱陀土〛", "E265"),
  ("〚⿵戊壬〛", "E266"),
  ("〚⿱⿰爿戓土〛", "E267"),
  ("〚⿳八斗田〛", "E268"),
  ("〚⿱𠅞力〛", "E269"),
  ("〚⿰金⿸厂⿱舌月〛", "E26A"),
  ("〚⿰畜刂〛", "E26B"),
  ("〚⿰⿱木辛斤〛", "E26C"),
  ("〚⿰矛命〛", "E26D"),
  ("〚⿱⿰阝⿱土田土〛", "E26E"),
  ("〚⿱唇又〛", "E26F"),
  ("〚⿱⿸辰日又〛", "E270"),
  ("〚⿱㞢所〛", "E271"),
  ("〚郭店未識字安以久動之之安〛", "E272"),
  ("〚郭店勾識〛", "E273"),
  ("〚郭店底本字形左〛", "E274"),
  ("〚郭店底本字形右〛", "E275"),
  ("〚郭店底本字形天〛", "E276"),
  ("〚郭店底本字形而〛", "E277"),
  ("〚郭店底本字形夫〛", "E278"),
  ("〚郭店底本字形推〛", "E279"),
  ("〚⿺辶隼〛", "E27A"),
  ("〚郭店底本字形廌〛", "E27B"),
  ("〚郭店底本字形普遍保〛", "E27C"),
  ("〚郭店底本字形单个保〛", "E27D"),
  ("〚⿰⿱幺言斤〛", "30561"),
  ("〚⿰亻⿱菐臣〛", "313E0"),
  ("〚⿰單犬〛", "30867"),
  ("〚⿰弓𠮡〛", "30413"),
  ("〚⿰爿𦣻〛", "30813"),
  ("〚⿰言千〛", "32062"),
  ("〚⿱⿻土从田〛", "308CB"),
  ("〚⿱乍又〛", "301BA"),
  ("〚⿱亡貝〛", "30DB2"),
  ("〚⿱僉日〛", "305B2"),
  ("〚⿱宀貝〛", "31687"),
  ("〚⿱既火〛", "307C5"),
  ("〚⿱日棗〛", "318A6"),
  ("〚⿱聿止〛", "30668"),
  ("〚⿱萬土〛", "302B6"),
  ("〚⿱虎口〛", "30C9B"),
  ("〚⿱身心〛", "30462"),
  ("〚⿱鬼示〛", "32327"),
  ("〚⿳甾冖用〛", "303C6"),
  ("〚⿸虘又〛", "30CA1"),
  ("〚⿺辶化〛", "32152"),
  ("〚⿺辶叀〛", "30EBF"),
  ("〚⿺辶复〛", "30EC7"),
  ("〚⿺辶童〛", "3217F"),

  // 北大本 :::::::::: 
  ("〚⿱宀射〛", "E301"), 
  ("〚⿱宀⿰身阝〛", "E302"),
  ("〚⿰木帚〛", "E303"),
  ("〚⿰𣐩系〛", "E304"),
  ("〚⿲彳⿱𭇁木亍〛", "E305"),
  ("〚⿰示⿱凶夂〛", "E306"),
  ("〚⿰言亡〛", "E307"),
  ("〚⿰言黑〛", "E308"),
  ("〚⿰氵蠶〛", "E309"),
  ("〚⿰犭亥〛", "E30A"),
  ("〚⿰馬敬〛", "E30B"),
  ("〚⿴囗⿱夂𠕁〛", "E30C"),
  ("〚⿺辶⿰阝⿱夂刖〛", "E30D"),
  ("〚北大底本字形列〛", "E30E"),
  ("〚北大底本字形死〛", "E30F"),
  ("〚北大底本字形⿰木帚〛", "E310"),
  ("〚北大底本字形椯〛", "E311"),
).map( ids-codepoint => {(
    ids-codepoint.first(), 
    str.from-unicode(eval("0x"+ids-codepoint.last())) // 如，将"E30C"这类转为字符。
)})

// 检查：ids 都是"〚...〛"这种格式。
#for (ids, _) in I数组-表意文字描述序列至码位I {
  if ids.contains(regex("^〚[^〛]+〛$")) {
    if ids.replace(regex("[^〚〛]"), "") == "〚〛" {
      continue
    }
  }
  panic("输入的IDS无效：" + ids)
}

// 检查：ids和字符，有无重复。
#let I数组-平铺元素I = I数组-表意文字描述序列至码位I.flatten()
#if I数组-平铺元素I.dedup().len() != I数组-平铺元素I.len(){
  panic(
    "I数组-表意文字描述序列至码位I：存在重复定义：", 
    I数组-平铺元素I // 过滤出，重复元素。
    .filter(x => I数组-平铺元素I.filter(y => x == y).len() > 1)
    .first()
  )
}

// 将字符串中所有IDS，替换成相应字符，返回最终替换结果。
#let IDS(text) = {
  for (ids, char) in I数组-表意文字描述序列至码位I {
    text = text.replace(ids, char)
  }
  return text
}

// 表达式："_"是保留文本，去其左右内容。如"〚_","〚_〛"
#let H去文本两端H(I代处理文本I, I表达式I) = {
  let (I左端I, I右端I) = I表达式I.split("_")
  I代处理文本I = I代处理文本I.trim(I左端I, at:start, repeat:false)
  I代处理文本I = I代处理文本I.trim(I右端I, at:end, repeat:false)
  return I代处理文本I
}

#let H汉转阿拉伯H(H汉H) = {
  let digits = ("一": 1, "二": 2, "三": 3, "四": 4, "五": 5,
                "六": 6, "七": 7, "八": 8, "九": 9)
  
  let chars = H汉H.split("")
  let result = 0
  
  for char in chars {
    if char == "十" {
      if result == 0 { result = 10} 
      else { result = result * 10}
    
    } 
    else if char in digits {
      if result >= 10 { result = result + digits.at(char)}
      else { result = digits.at(char) }
    }
  }
  
  // 格式化为两位数字
  if result < 10 { "0" + str(result) }
  else { str(result) }
}

#let H阿拉伯转汉H(num) = {
  let chinese-digits = ("", "一", "二", "三", "四", 
                        "五", "六", "七", "八", "九")
  
  if num < 10 { return chinese-digits.at(num)} 
  else {
    let tens = int(num / 10)
    let ones = calc.rem(num, 10)
    
    // 处理十位：如果是1x，通常读作“十”，而不是“一十”
    let tens-str = if tens == 1 { "十" } else { chinese-digits.at(tens) + "十" }
    
    // 处理个位：如果是0，则不显示（如 20 是“二十”）
    let ones-str = chinese-digits.at(ones)
    
    return tens-str + ones-str
  }
}

#let H全部章节名H = range(1,82).map(x => "第" + H阿拉伯转汉H(x) + "章")