<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è„šæœ¬-ä»Typstä»£ç è¿˜åŸåŸæ–‡</title>
    <style>
       body { margin: 0; padding: 40px 0; font-family: sans-serif; background-color: #fcfcfc; }
        .container { display: flex; flex-direction: column; align-items: center; gap: 20px; width: 100%; }
        .item { width: 80%; max-width: 800px; box-sizing: border-box; }
        textarea { height: 250px; padding: 15px; font-size: 16px; border: 2px solid #ddd; border-radius: 8px; resize: vertical; transition: border-color 0.3s; }
        textarea:focus { border-color: #4a90e2; outline: none; }
        #targetText { background-color: #f9f9f9; color: #333; }
        .hint { color: #555; font-size: 14px; padding: 8px 25px; background-color: #ffffff; border: 1px solid #ccc; border-radius: 50px; margin-bottom: 0px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-weight: 500; }
    </style>
</head>
<body>

    <div class="container">
        <div class="hint">ğŸ’¡ åœ¨ä¸‹æ–¹ç²˜è´´åŒ…å«åŸæ–‡çš„Typstä»£ç ï¼Œå°†è‡ªåŠ¨å®æ—¶è¿˜åŸä¸ºåŸæ–‡</div>
        <textarea id="sourceText" class="item" placeholder="å°†å¦‚ [åŒ—å¤§æœ¬.typ] æ–‡ä»¶é‡Œçš„å†…å®¹ï¼Œå…¨é€‰ï¼Œç²˜è´´è‡³æ­¤..."></textarea>
        <textarea id="targetText" class="item" placeholder="è¿˜åŸçš„åŸæ–‡å°†å®æ—¶æ˜¾ç¤ºåœ¨è¿™é‡Œã€‚" readonly></textarea>
    </div>

    <script>
        const sourceInput = document.getElementById('sourceText');
        const targetInput = document.getElementById('targetText');

        sourceInput.addEventListener('input', () => {
            const { value } = sourceInput;
            if (value.trim() === "") {
                targetInput.value = "";
                return;
            }
            targetInput.value = processContent(value);
        });
    /**
     * å¤„ç† Typst ä»£ç å†…å®¹çš„æ ¸å¿ƒå‡½æ•°
     * @param {string} typstCode åŸå§‹è¾“å…¥çš„å­—ç¬¦ä¸²
     */
    function processContent(typstCode) {
        
        // 1. æ¸…ç†ç‰¹å®šæ ¼å¼çš„æ–¹æ‹¬å·å†…å®¹
        // æ­£åˆ™è§£é‡Šï¼šåŒ¹é…å½¢å¦‚ [A][B][C][D] çš„å››è¿æ–¹æ‹¬å·ç»“æ„ï¼Œ
        // åªä¿ç•™ç¬¬ 1 ä¸ªå’Œç¬¬ 4 ä¸ªæ‹¬å·é‡Œçš„å†…å®¹ï¼ˆ$1$2ï¼‰ï¼Œåˆ æ‰ä¸­é—´ä¸¤ä¸ªæ‹¬å·åŠå…¶å†…å®¹ã€‚
        const noBrackets = typstCode.replace(/\[([^\]]*)\]\[[^\]]*\]\[[^\]]*\]\[([^\]]*)\]/g, '$1$2');

        // 2. æå–åŒå¼•å·å†…çš„å†…å®¹
        // å°†æ‰€æœ‰è¢«åŒå¼•å·""åŒ…è£¹çš„éƒ¨åˆ†æå–å‡ºæ¥å­˜å…¥æ•°ç»„ã€‚
        const matches = noBrackets.match(/"(.*?)"/g) || [];
        const unquotedMatches = matches.map(m => m.slice(1, -1)); // å»æ‰å¼•å·ï¼Œæå–çº¯æ–‡æœ¬

        // 3. ç¡®å®šæ¸²æŸ“æ¨¡å¼
        // æ£€æŸ¥æå–å‡ºçš„æ‰€æœ‰æ–‡æœ¬ä¸­æ˜¯å¦åŒ…å«â€œã€šLâ€æ ‡è®°ã€‚
        // å¦‚æœæ²¡æœ‰è¿™ä¸ªæ ‡è®°ï¼Œåˆ™åˆ¤å®šä¸ºè¾“å‡ºå¸¦æ ‡é¢˜çš„æ¨¡å¼ (needsTitle)ã€‚
        const needsTitle = !unquotedMatches.join("").includes("ã€šL");

        // 4. æ ¸å¿ƒå¤„ç†å¾ªç¯ï¼šå¤„ç†æ¯ä¸€ä¸ªç”±å¼•å·æå–å‡ºçš„æ®µè½ï¼ˆç« /èŠ‚ï¼‰
        const chaptersOrdered = unquotedMatches.map(chapterStr => {
            const units = chapterStr.split("&"); // ä½¿ç”¨ & ç¬¦å·åˆ‡å‰²æˆä¸åŒçš„å•å…ƒ
            let processedChapter = []; // å­˜å‚¨å¤„ç†åçš„æ®µè½å†…å®¹
            let sortArray = [];        // æ’åºæš‚å­˜åŒº
            let isSorting = false;     // æ˜¯å¦å¤„äºæ’åºæ¨¡å¼çš„å¼€å…³

            for (const unit of units) {
                // æ¨¡å¼å¼€å…³ï¼šé‡åˆ°â€œâ–©â€ç¬¦å·ï¼Œå¼€å¯æ’åºæ¨¡å¼
                if (unit === "â–©") {
                    isSorting = true;
                    continue;
                } 
                // æ¨¡å¼å¼€å…³ï¼šé‡åˆ°â€œâ–¦â€ç¬¦å·ï¼Œå…³é—­æ’åºæ¨¡å¼å¹¶æ‰§è¡Œæ’åºé€»è¾‘
                if (unit === "â–¦") {
                    isSorting = false;
                    // æŒ‰å­—æ¯å›¾æ ‡ï¼ˆğŸ…°, ğŸ…±...ï¼‰çš„æœ¬åœ°é¡ºåºå¯¹æš‚å­˜åŒºè¿›è¡Œæ’åº
                    sortArray.sort((a, b) => a[0].localeCompare(b[0]));
                    // æ’åºå®Œæˆåï¼Œæå–å†…å®¹éƒ¨åˆ†ï¼ˆå»æ‰å­—æ¯æ ‡ç­¾ï¼‰å¹¶åˆå¹¶ï¼Œå­˜å…¥ç»“æœæ•°ç»„
                    processedChapter.push(sortArray.map(([letter, ...content]) => content.join("")).join(""));
                    sortArray = []; // æ¸…ç©ºæš‚å­˜åŒº
                    continue;
                }

                if (isSorting) {
                    // å¦‚æœåœ¨æ’åºæ¨¡å¼å†…ï¼š
                    // å¦‚æœå½“å‰å•å…ƒæ˜¯å­—æ¯å›¾æ ‡ï¼Œåˆ™åœ¨ sortArray ä¸­å¼€å¯ä¸€ä¸ªæ–°ç»„
                    if (unit !== "" && "ğŸ…°ğŸ…±ğŸ…²ğŸ…³ğŸ…´".includes(unit)) {
                        sortArray.push([unit]); 
                    } else if (sortArray.length > 0) {
                        // å¦‚æœæ˜¯æ™®é€šæ–‡å­—ï¼Œåˆ™å½’å…¥å½“å‰æœ€åä¸€ä¸ªå­—æ¯ç»„ä¸­
                        sortArray[sortArray.length - 1].push(unit);
                    }
                } else {
                    // å¦‚æœä¸åœ¨æ’åºæ¨¡å¼å†…ï¼Œç›´æ¥å°†å†…å®¹å­˜å…¥ç»“æœ
                    processedChapter.push(unit);
                }
            }
            return processedChapter; // è¿”å›å¤„ç†ï¼ˆå’Œæ’åºï¼‰åçš„å•å…ƒæ•°ç»„
        });

        // 5. æœ€ç»ˆç»„è£ä¸è¾“å‡ºæ ¼å¼åŒ–
        if (needsTitle) {
            // æ¨¡å¼ Aï¼šå¸¦æ ‡é¢˜æ¨¡å¼
            // å‡è®¾ç»“æ„ä¸º [ID, ç‰ˆæœ¬, ...æ­£æ–‡]ï¼Œæ ¼å¼åŒ–ä¸º "ID\næ­£æ–‡\n"
            return chaptersOrdered
                .map(([id, version, ...body]) => `${id}\n${body.join("")}\n`)
                .join("");
        } else {
            // æ¨¡å¼ Bï¼šæµå¼æ¨¡å¼ï¼ˆæ— æ ‡é¢˜ï¼‰
            // å…ˆæŠŠæ‰€æœ‰å†…å®¹å‹æˆä¸€è¡Œï¼Œå»æ‰æ‰€æœ‰åŸå§‹æ¢è¡Œç¬¦
            const oneLine = chaptersOrdered
                .map(([id, version, ...body]) => body.join(""))
                .join("")
                .replace(/\n/g, "");
            
            // æœ€ååœ¨æ‰€æœ‰çš„â€œã€šL...ã€›â€æ ‡è®°åé¢å¼ºåˆ¶åŠ ä¸Šæ¢è¡Œç¬¦ï¼Œå®ç°æŒ‰æ ‡è®°åˆ†è¡Œ
            return oneLine.replace(/ã€šL.*?ã€›/g, '$&\n');
        }
    }

    </script>
</body>
</html>